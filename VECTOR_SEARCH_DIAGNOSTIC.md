# Vector Search Diagnostic: Will New Approach Solve the 0 Documents Problem?

## üîç Problem Analysis

### Current Issues:
1. **Vector search returns 0 documents**
   - Similarity threshold too high (0.75)
   - Query filters not matching

### Root Causes:

#### Issue 1: Similarity Threshold (0.75) - ‚ö†Ô∏è **NOT FULLY SOLVED**
**Current Behavior:**
- Documents are retrieved from DB
- Then filtered by `similarity >= 0.75`
- If all documents have similarity < 0.75, result is empty

**Why 0.75 is High:**
- Cosine similarity ranges from 0.0 to 1.0
- 0.75 means documents must be 75% similar
- For semantic search, typical good matches are 0.6-0.8
- 0.75 filters out many valid matches

**New Approach Impact:**
- ‚úÖ Better document structure ‚Üí better semantic matching
- ‚úÖ More specific content ‚Üí potentially higher similarity scores
- ‚ùå **But threshold is still 0.75** ‚Üí may still filter out valid matches

#### Issue 2: Query Filters Not Matching - ‚úÖ **LARGELY SOLVED**

**Old Problems:**
1. `cluster_name` empty string vs NULL issue ‚Üí **FIXED** (now passes NULL)
2. Generic document types ‚Üí less precise matching
3. No `doc_sub_type` filtering ‚Üí searching too broadly

**New Approach Fixes:**
- ‚úÖ Better intent detection ‚Üí routes to correct `doc_sub_type`
- ‚úÖ More specific queries ‚Üí `source_type + doc_sub_type` filtering
- ‚úÖ Better document structure ‚Üí atomic, intention-aware content
- ‚úÖ Time scope detection ‚Üí routes to daily/weekly appropriately
- ‚úÖ Component detection ‚Üí routes to kafka/spark/dataapi lineage

**Example Improvement:**
```
Old Query: "What is the schema?"
‚Üí Searches: source_type='METADATA' (all metadata types)
‚Üí May match business_metadata, storage_configuration, etc.
‚Üí Lower similarity scores due to broader matching

New Query: "What is the schema?"
‚Üí Searches: source_type='METADATA' AND doc_sub_type='schema_metadata'
‚Üí Only matches schema documents
‚Üí Higher similarity scores due to precise matching
```

---

## ‚úÖ What the New Approach Fixes

### 1. **Better Intent Detection ‚Üí Precise Filtering**
**Before:**
- Question: "What is the schema of dda_transactions?"
- Searches: `source_type='METADATA'` (all metadata)
- May match: business_metadata, storage_configuration, etc.
- Result: Lower similarity scores, more noise

**After:**
- Question: "What is the schema of dda_transactions?"
- Detects: `doc_sub_type='schema_metadata'`
- Searches: `source_type='METADATA' AND doc_sub_type='schema_metadata'`
- Only matches: Schema documents
- Result: **Higher similarity scores, precise matches**

### 2. **Better Document Structure ‚Üí Better Embeddings**
**Before:**
- Generic documents with mixed content
- Less focused semantic meaning
- Embeddings capture mixed signals

**After:**
- Atomic, intention-aware documents
- Focused content per document type
- Embeddings capture specific semantic meaning
- **Result: Better semantic matching**

### 3. **Time Scope Detection ‚Üí Appropriate Document Selection**
**Before:**
- "Why is dda_transactions slow today?"
- Searches: All LOG_SUMMARY and METRIC_SUMMARY
- May match weekly summaries (less relevant)

**After:**
- "Why is dda_transactions slow today?"
- Detects: `time_scope='daily'`
- Searches: `doc_sub_type IN ('logs_daily', 'metrics_daily')`
- **Result: More relevant, recent documents**

### 4. **Component Detection ‚Üí Precise Lineage Routing**
**Before:**
- "Which Kafka topic feeds this table?"
- Searches: All LINEAGE documents
- May match spark, dataapi lineage (less relevant)

**After:**
- "Which Kafka topic feeds this table?"
- Detects: `component='kafka'`
- Searches: `source_type='LINEAGE' AND doc_sub_type='lineage_kafka'`
- **Result: Precise lineage matches**

---

## ‚ö†Ô∏è What Still Needs Attention

### 1. **Similarity Threshold (0.75) - Still Too High**

**Recommendation: Lower to 0.6 or 0.65**

**Why:**
- Semantic similarity is different from exact matching
- Good matches typically range 0.6-0.8
- 0.75 filters out many valid matches
- Better to retrieve more and let LLM filter

**Fix:**
```yaml
# application.yml
rag:
  similarity-threshold: ${RAG_SIMILARITY_THRESHOLD:0.65}  # Lowered from 0.75
```

**Or make it configurable per query type:**
- Schema queries: 0.7 (more specific)
- RCA queries: 0.6 (broader context needed)
- General queries: 0.65 (balanced)

### 2. **No Documents in Database**

**Check:**
```sql
SELECT COUNT(*) FROM rag_documents WHERE table_name = 'dda_transactions';
```

**If 0:**
- Need to load the 12 canonical documents
- Run: `python3 mvp/scripts/load_canonical_documents.py`

### 3. **Embedding Mismatch**

**Potential Issue:**
- Query embedding generated by Phi-4
- Document embeddings generated by MiniLM (all-MiniLM-L6-v2)
- Different models ‚Üí different embedding spaces
- **This is OK** - both are semantic embeddings, but similarity scores may be lower

**Solution:**
- Use same embedding model for both query and documents
- Or accept lower similarity scores and lower threshold

---

## üéØ Expected Improvements

### Before (Old Approach):
```
Query: "What is the schema of dda_transactions?"
‚Üí Searches: source_type='METADATA' (all types)
‚Üí Retrieves: 5 documents (business, schema, storage, etc.)
‚Üí Similarity scores: [0.68, 0.72, 0.65, 0.71, 0.69]
‚Üí After threshold (0.75): 0 documents ‚ùå
```

### After (New Approach):
```
Query: "What is the schema of dda_transactions?"
‚Üí Detects: doc_sub_type='schema_metadata'
‚Üí Searches: source_type='METADATA' AND doc_sub_type='schema_metadata'
‚Üí Retrieves: 1 document (schema only)
‚Üí Similarity score: [0.82]
‚Üí After threshold (0.75): 1 document ‚úÖ
```

**But if threshold is still 0.75 and similarity is 0.72:**
```
‚Üí After threshold (0.75): 0 documents ‚ùå
‚Üí Need to lower threshold to 0.65: 1 document ‚úÖ
```

---

## üìä Recommendations

### Immediate Actions:

1. **Lower Similarity Threshold:**
   ```yaml
   rag:
     similarity-threshold: 0.65  # Lower from 0.75
   ```

2. **Load Documents:**
   ```bash
   cd mvp/scripts
   python3 load_canonical_documents.py
   ```

3. **Test with Lower Threshold:**
   ```bash
   curl -X POST http://localhost:8080/api/rag/search-vector \
     -H "Content-Type: application/json" \
     -d '{"question":"What is the schema of dda_transactions?","docTypes":["METADATA"],"topK":3}'
   ```

4. **Check Logs for Similarity Scores:**
   - Look for: "Retrieved X documents, Y passed similarity threshold"
   - If Y = 0 but X > 0, threshold is too high

### Long-term Improvements:

1. **Adaptive Threshold:**
   - Lower threshold if no results found
   - Retry with threshold - 0.1

2. **Per-Query-Type Thresholds:**
   - Schema queries: 0.7
   - RCA queries: 0.6
   - General queries: 0.65

3. **Logging Enhancement:**
   - Log actual similarity scores before filtering
   - Help diagnose threshold issues

---

## ‚úÖ Conclusion

**Will the new approach solve the problem?**

**Partially:**
- ‚úÖ **Query filters not matching** ‚Üí **LARGELY SOLVED**
  - Better intent detection
  - Precise doc_sub_type filtering
  - Better document structure
  
- ‚ö†Ô∏è **Similarity threshold too high** ‚Üí **STILL NEEDS FIX**
  - New approach helps (better matching)
  - But threshold 0.75 is still too high
  - **Recommendation: Lower to 0.65**

**Combined Effect:**
- New approach: Better matching ‚Üí Higher similarity scores
- Lower threshold: Allows more valid matches through
- **Result: Should solve the 0 documents problem**

**Action Items:**
1. ‚úÖ New approach implemented (better filtering)
2. ‚è≥ Lower similarity threshold to 0.65
3. ‚è≥ Load 12 canonical documents
4. ‚è≥ Test and verify

